<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRC Financial Statement Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add jQuery BEFORE DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <style>
        :root {
            --frc-primary: #2c3e50;
            --frc-secondary: #3498db;
            --frc-success: #27ae60;
            --frc-warning: #f39c12;
            --frc-danger: #e74c3c;
            --frc-info: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar {
            background: linear-gradient(135deg, var(--frc-primary) 0%, #34495e 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            background-color: white;
            min-height: 100vh;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .sidebar .nav-link {
            color: var(--frc-primary);
            padding: 12px 20px;
            border-radius: 5px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: var(--frc-secondary);
            color: white;
        }

        .main-content {
            padding: 20px;
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--frc-primary) 0%, #34495e 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }

        .company-card {
            border-left: 5px solid var(--frc-secondary);
        }

        .risk-high {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--frc-danger);
        }

        .risk-moderate {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--frc-warning);
        }

        .risk-low {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--frc-success);
        }

        .ratio-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .financial-table {
            font-size: 0.9em;
        }

        .financial-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .compliance-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .compliance-compliant {
            background-color: #d4edda;
            color: #155724;
        }

        .compliance-partial {
            background-color: #fff3cd;
            color: #856404;
        }

        .compliance-non-compliant {
            background-color: #f8d7da;
            color: #721c24;
        }

        .tab-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
        }

        .search-box {
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                position: relative;
            }

            .main-content {
                padding: 10px;
            }
        }

        .company-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--frc-secondary) 0%, #2980b9 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-critical {
            background-color: var(--frc-danger);
            animation: pulse 2s infinite;
        }

        .status-warning {
            background-color: var(--frc-warning);
        }

        .status-ok {
            background-color: var(--frc-success);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .export-btn {
            background: linear-gradient(135deg, var(--frc-success) 0%, #229954 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .confidential-watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 50px;
            color: rgba(231, 76, 60, 0.1);
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
            font-weight: bold;
        }

        .note-number {
            font-size: 0.8em;
            color: var(--frc-secondary);
            background-color: #e8f4fd;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
            font-weight: bold;
        }

        .note-reference {
            font-size: 0.75em;
            color: #666;
            font-style: italic;
            margin-left: 10px;
        }

        .full-number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .year-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Confidential Watermark -->
    <div class="confidential-watermark d-none" id="confidentialWatermark">
        FRC - CONFIDENTIAL
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-bar-chart-fill me-2"></i>
                FRC Analysis Dashboard
            </a>
            <div class="d-flex">
                <div class="input-group search-box">
                    <input type="text" class="form-control" placeholder="Search companies..." id="searchInput">
                    <button class="btn btn-outline-light" type="button">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <button class="btn export-btn ms-2" id="exportBtn">
                    <i class="bi bi-download me-1"></i> Export Report
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3 sidebar d-none d-md-block">
                <div class="p-3">
                    <h5 class="mb-4">Companies</h5>
                    <div class="list-group" id="companyList">
                        <!-- Company list will be populated here -->
                    </div>

                    <hr class="my-4">

                    <h6 class="mb-2">Source Documents</h6>
                    <div class="d-grid gap-2">
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://github.com/asicoltd/my-site/blob/main/Anwer%20Khan%20Modern%20Hospital%20Audited%20FSs-1_compressed.pdf"
                            target="_blank" rel="noopener">AKMH Audited FS 1</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://github.com/asicoltd/my-site/blob/main/Anwer%20Khan%20Modern%20Hospital%20Audited%20FSs-2_compressed.pdf"
                            target="_blank" rel="noopener">AKMH Audited FS 2</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://github.com/asicoltd/my-site/blob/main/Anwer%20Khan%20Modern%20Hospital%20Audited%20FSs-3_compressed.pdf"
                            target="_blank" rel="noopener">AKMH Audited FS 3</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://drive.google.com/file/d/1gHvTHnfqDZH1mj8V2iuEbuVxlM-QA-LA/view?usp=drive_link"
                            target="_blank" rel="noopener">Bank Asia 2024</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://drive.google.com/file/d/1M6Ygu-4x7wXnLvKnTI8AneAEZ_9yAUAM/view?usp=drive_link"
                            target="_blank" rel="noopener">Bank Asia 2023</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://drive.google.com/file/d/1GwiFI7vy2FDbYUmcIWXXbDE1pV8J6E8E/view?usp=drive_link"
                            target="_blank" rel="noopener">Bank Asia 2022</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://drive.google.com/file/d/1xgyayKPHmXr0H3A3Ryrn--Q3__fK9qWz/view?usp=sharing"
                            target="_blank" rel="noopener">Dominage 2023-2024</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://drive.google.com/file/d/1pyVPolYAGXA51QWNseHtzgnF7BCs0qd5/view?usp=drive_link"
                            target="_blank" rel="noopener">SIBL 2023</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://drive.google.com/file/d/1xouZOq0aj5mdK5-cuDANF2ywuH1FVytE/view?usp=sharing"
                            target="_blank" rel="noopener">SIBL 2024</a>
                        <a class="btn btn-sm btn-outline-secondary"
                            href="https://drive.google.com/file/d/1KWvqfm7hPX_q23Zj-hF1tOzw4xFzklRe/view?usp=sharing"
                            target="_blank" rel="noopener">APEX SPINNING & KNITTING MILLS LIMITED Annual Report 2024-2025</a>
                    </div>


                </div>
            </div>

            <!-- Mobile Sidebar Toggle -->
            <div class="d-md-none mb-3">
                <button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse"
                    data-bs-target="#mobileSidebar">
                    <i class="bi bi-list me-2"></i> Show Companies & Filters
                </button>
                <div class="collapse mt-2" id="mobileSidebar">
                    <div class="card">
                        <div class="card-body">
                            <div id="mobileCompanyList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-9 main-content">
                <!-- Dashboard Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 id="companyName">Select a Company</h3>
                                        <p class="text-muted mb-0" id="companyDescription">Click on a company from the
                                            sidebar to view detailed analysis</p>
                                    </div>
                                    <div class="text-end">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="status-indicator" id="complianceStatusIcon"></span>
                                            <span class="small" id="complianceStatus">-</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="status-indicator" id="auditStatusIcon"></span>
                                            <span class="small" id="auditStatus">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row mb-4" id="quickStats" style="display: none;">
                    <div class="col-lg-3 col-md-6">
                        <div class="card company-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Total Assets</h6>
                                        <h4 class="mb-0" id="totalAssets">-</h4>
                                    </div>
                                    <div class="avatar-sm rounded-circle bg-primary bg-opacity-10">
                                        <i class="bi bi-building text-primary fs-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card company-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Net Profit</h6>
                                        <h4 class="mb-0" id="netProfit">-</h4>
                                    </div>
                                    <div class="avatar-sm rounded-circle bg-success bg-opacity-10">
                                        <i class="bi bi-currency-dollar text-success fs-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card company-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Current Ratio</h6>
                                        <h4 class="mb-0" id="currentRatio">-</h4>
                                    </div>
                                    <div class="avatar-sm rounded-circle bg-info bg-opacity-10">
                                        <i class="bi bi-arrow-left-right text-info fs-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card company-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Risk Level</h6>
                                        <h4 class="mb-0" id="riskLevel">-</h4>
                                    </div>
                                    <div class="avatar-sm rounded-circle bg-warning bg-opacity-10">
                                        <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Tabs -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                            data-bs-target="#overview" type="button">
                            <i class="bi bi-house-door me-1"></i> Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financials-tab" data-bs-toggle="tab" data-bs-target="#financials"
                            type="button">
                            <i class="bi bi-cash-coin me-1"></i> Financial Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="compliance-tab" data-bs-toggle="tab" data-bs-target="#compliance"
                            type="button">
                            <i class="bi bi-clipboard-check me-1"></i> IFRS Compliance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit"
                            type="button">
                            <i class="bi bi-file-earmark-text me-1"></i> Audit & Governance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="risks-tab" data-bs-toggle="tab" data-bs-target="#risks"
                            type="button">
                            <i class="bi bi-exclamation-triangle me-1"></i> Risk Analysis
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="mainTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Financial Performance Trend (BDT)</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="performanceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Key Findings</h5>
                                    </div>
                                    <div class="card-body" id="keyFindings">
                                        <!-- Key findings will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Financial Statement Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover financial-table" id="financialSummaryTable">
                                                <thead>
                                                    <tr>
                                                        <th>Year</th>
                                                        <th>Revenue</th>
                                                        <th>Net Profit</th>
                                                        <th>Total Assets</th>
                                                        <th>Total Liabilities</th>
                                                        <th>Equity</th>
                                                        <th>Current Ratio</th>
                                                        <th>ROA</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="financialSummaryBody">
                                                    <!-- Data will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Analysis Tab -->
                    <div class="tab-pane fade" id="financials" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Financial Statements</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="nav nav-tabs mb-3" id="financialTabs" role="tablist">
                                            <li class="nav-item">
                                                <button class="nav-link active" id="balance-sheet-tab"
                                                    data-bs-toggle="tab" data-bs-target="#balance-sheet">
                                                    Balance Sheet
                                                </button>
                                            </li>
                                            <li class="nav-item">
                                                <button class="nav-link" id="income-statement-tab" data-bs-toggle="tab"
                                                    data-bs-target="#income-statement">
                                                    Income Statement
                                                </button>
                                            </li>
                                            <li class="nav-item">
                                                <button class="nav-link" id="cashflow-tab" data-bs-toggle="tab"
                                                    data-bs-target="#cashflow">
                                                    Cash Flow
                                                </button>
                                            </li>
                                            <li class="nav-item">
                                                <button class="nav-link" id="ratios-tab" data-bs-toggle="tab"
                                                    data-bs-target="#ratios">
                                                    Ratio Analysis
                                                </button>
                                            </li>
                                            <li class="nav-item">
                                                <button class="nav-link" id="notes-tab" data-bs-toggle="tab"
                                                    data-bs-target="#notes">
                                                    Notes
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content">
                                            <div class="tab-pane fade show active" id="balance-sheet">
                                                <div class="table-responsive">
                                                    <table class="table table-hover financial-table"
                                                        id="balanceSheetTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Line Item</th>
                                                                <th>Note</th>
                                                                <!-- Year columns will be dynamically added here -->
                                                            </tr>
                                                        </thead>
                                                        <tbody id="balanceSheetBody">
                                                            <!-- Data will be populated here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="income-statement">
                                                <div class="table-responsive">
                                                    <table class="table table-hover financial-table"
                                                        id="incomeStatementTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Line Item</th>
                                                                <th>Note</th>
                                                                <!-- Year columns will be dynamically added here -->
                                                            </tr>
                                                        </thead>
                                                        <tbody id="incomeStatementBody">
                                                            <!-- Data will be populated here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="cashflow">
                                                <div class="table-responsive">
                                                    <table class="table table-hover financial-table" id="cashFlowTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Cash Flow Category</th>
                                                                <th>Note</th>
                                                                <!-- Year columns will be dynamically added here -->
                                                            </tr>
                                                        </thead>
                                                        <tbody id="cashFlowBody">
                                                            <!-- Data will be populated here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="ratios">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="card mb-3">
                                                            <div class="card-header">
                                                                <h6 class="mb-0">Liquidity Ratios</h6>
                                                            </div>
                                                            <div class="card-body" id="liquidityRatios">
                                                                <!-- Data will be populated here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card mb-3">
                                                            <div class="card-header">
                                                                <h6 class="mb-0">Profitability Ratios</h6>
                                                            </div>
                                                            <div class="card-body" id="profitabilityRatios">
                                                                <!-- Data will be populated here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card mb-3">
                                                            <div class="card-header">
                                                                <h6 class="mb-0">Solvency Ratios</h6>
                                                            </div>
                                                            <div class="card-body" id="solvencyRatios">
                                                                <!-- Data will be populated here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card mb-3">
                                                            <div class="card-header">
                                                                <h6 class="mb-0">Efficiency Ratios</h6>
                                                            </div>
                                                            <div class="card-body" id="efficiencyRatios">
                                                                <!-- Data will be populated here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="notes">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">Notes to Financial Statements</h6>
                                                    </div>
                                                    <div class="card-body" id="notesContent">
                                                        <!-- Notes will be populated here -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Tab -->
                    <div class="tab-pane fade" id="compliance" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">IFRS Compliance Matrix</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="complianceTable">
                                                <thead>
                                                    <tr>
                                                        <th>Standard</th>
                                                        <th>Compliance Status</th>
                                                        <th>Requirements Checked</th>
                                                        <th>Issues Identified</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="complianceBody">
                                                    <!-- Data will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Compliance Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="complianceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Material Departures</h5>
                                    </div>
                                    <div class="card-body" id="materialDepartures">
                                        <!-- Data will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit & Governance Tab -->
                    <div class="tab-pane fade" id="audit" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Audit Report Analysis</h5>
                                    </div>
                                    <div class="card-body" id="auditAnalysis">
                                        <!-- Data will be populated here -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Corporate Governance</h5>
                                    </div>
                                    <div class="card-body" id="governanceAnalysis">
                                        <!-- Data will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Key Audit Matters</h5>
                                    </div>
                                    <div class="card-body" id="keyAuditMatters">
                                        <!-- Data will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Analysis Tab -->
                    <div class="tab-pane fade" id="risks" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Risk Assessment Dashboard</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="riskChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Risk Indicators</h5>
                                    </div>
                                    <div class="card-body" id="riskIndicators">
                                        <!-- Data will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Going Concern Assessment</h5>
                                    </div>
                                    <div class="card-body" id="goingConcern">
                                        <!-- Data will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Detailed View -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalTitle">Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Detailed content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Bootstrap JS (comes after jQuery) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS (comes after jQuery) -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Global variables
        let frcData = null;
        let currentCompany = null;
        let performanceChart = null;
        let complianceChart = null;
        let riskChart = null;

        // Format number with commas (FULL NUMBER FORMAT)
        function formatNumber(num) {
            if (num === null || num === undefined || num === '-' || num === '') return '-';

            // Remove any existing commas
            const numStr = num.toString().replace(/,/g, '');

            // Check if it's a valid number
            if (!/^-?\d*\.?\d+$/.test(numStr)) return numStr;

            // Convert to number
            const numFloat = parseFloat(numStr);
            if (isNaN(numFloat)) return numStr;

            // Format with commas for thousands separators
            return numFloat.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Format currency (FULL NUMBERS ONLY - NO B/K/M)
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || amount === '-' || amount === '') return '-';

            // Remove any existing commas
            const numStr = amount.toString().replace(/,/g, '');

            // Check if it's a valid number
            if (!/^-?\d*\.?\d+$/.test(numStr)) return numStr;

            // Convert to number
            const num = parseFloat(numStr);
            if (isNaN(num)) return amount;

            // Always show full number with commas
            return 'BDT ' + formatNumber(num);
        }

        // Format number for display (FULL NUMBER)
        function formatDisplayNumber(num) {
            return formatNumber(num);
        }

        // Get note reference display
        function formatNoteReference(note) {
            if (!note) return '';
            if (typeof note === 'string') return `<span class="note-number">${note}</span>`;
            if (typeof note === 'object') {
                // Handle object format like {"2022": "3.00", "2023": "3.00", "2024": "3.00"}
                return Object.values(note).join(', ');
            }
            return note.toString();
        }

        // Calculate percentage change
        function calculateChange(current, previous) {
            if (!current || !previous || previous == 0) return null;
            const change = ((parseFloat(current) - parseFloat(previous)) / Math.abs(parseFloat(previous))) * 100;
            return change.toFixed(1);
        }

        // Get risk level class
        function getRiskClass(risk) {
            if (!risk) return '';
            switch (risk.toLowerCase()) {
                case 'high':
                case 'critical':
                    return 'risk-high';
                case 'moderate':
                case 'medium':
                    return 'risk-moderate';
                case 'low':
                    return 'risk-low';
                default:
                    return '';
            }
        }

        // Get risk status indicator
        function getRiskStatusIcon(risk) {
            if (!risk) return 'status-ok';
            switch (risk.toLowerCase()) {
                case 'high':
                case 'critical':
                    return 'status-critical';
                case 'moderate':
                case 'medium':
                    return 'status-warning';
                case 'low':
                    return 'status-ok';
                default:
                    return 'status-ok';
            }
        }

        // Add this function to detect available years from data
        function getAvailableYears(companyData) {
            const years = new Set();
            
            // Check all statement types for available years
            const statementTypes = [
                'statement_of_financial_position',
                'statement_of_profit_or_loss_and_oci',
                'statement_of_cash_flows',
                'statement_of_changes_in_equity'
            ];
            
            statementTypes.forEach(statementType => {
                const statements = companyData?.financial_statements_raw_data?.[statementType];
                if (statements && Array.isArray(statements)) {
                    statements.forEach(item => {
                        if (item) {
                            // Check for each year field
                            const yearFields = [
                                'current_year_amount',
                                'prior_year_1_amount',
                                'prior_year_2_amount',
                                'prior_year_3_amount'
                            ];
                            
                            yearFields.forEach(field => {
                                if (item[field] !== undefined && item[field] !== '' && item[field] !== null) {
                                    // Extract year key from field name
                                    const yearKey = field.replace('_amount', '');
                                    years.add(yearKey);
                                }
                            });
                        }
                    });
                }
            });
            
            // Convert to array and sort by recency
            const yearOrder = ['current_year', 'prior_year_1', 'prior_year_2', 'prior_year_3'];
            const availableYears = Array.from(years)
                .sort((a, b) => yearOrder.indexOf(a) - yearOrder.indexOf(b));
            
            return availableYears;
        }

        // Function to get year label from year key
        function getYearLabel(yearKey, companyInfo) {
            // Get current year
            const currentYear = 2023;
            
            // Default mapping
            const defaultMapping = {
                'current_year': `${currentYear}`,
                'prior_year_1': `${currentYear - 1}`,
                'prior_year_2': `${currentYear - 2}`,
                'prior_year_3': `${currentYear - 3}`
            };
            
            // If we have financial year end info, use it
            if (companyInfo && companyInfo.financial_year_end) {
                const fye = companyInfo.financial_year_end.toLowerCase();
                
                // Try to extract year from reporting_years if available
                if (companyInfo.reporting_years && companyInfo.reporting_years[yearKey]) {
                    return companyInfo.reporting_years[yearKey];
                }
                
                // Otherwise use financial year end to determine labels
                if (fye.includes('june')) {
                    // Financial year ending June
                    const yearOffset = {
                        'current_year': 0,
                        'prior_year_1': -1,
                        'prior_year_2': -2,
                        'prior_year_3': -3
                    }[yearKey] || 0;
                    
                    const endYear = currentYear + yearOffset;
                    return `FY ${endYear}`;
                } else if (fye.includes('december')) {
                    // Calendar year
                    const yearOffset = {
                        'current_year': 0,
                        'prior_year_1': -1,
                        'prior_year_2': -2,
                        'prior_year_3': -3
                    }[yearKey] || 0;
                    
                    return `${currentYear + yearOffset}`;
                }
            }
            
            return defaultMapping[yearKey] || yearKey.replace('_', ' ').toUpperCase();
        }

        // Function to get year headers for tables
        function getYearHeaders(availableYears, companyInfo) {
            return availableYears.map(yearKey => {
                const label = getYearLabel(yearKey, companyInfo);
                return {
                    key: yearKey,
                    label: label,
                    dataKey: `${yearKey}_amount`,
                    fieldName: `${yearKey}_amount`
                };
            });
        }

        // Load JSON data
        async function loadData() {
            try {
                console.log('Loading company.json...');
                const response = await fetch('company.json');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Data loaded successfully');

                // Handle different JSON structures
                if (data.frc_analysis_report) {
                    frcData = data.frc_analysis_report;
                } else if (data.companies) {
                    frcData = data;
                } else {
                    frcData = {
                        metadata: {
                            report_id: "FRC-ANL-2024-001",
                            generation_date: new Date().toISOString().split('T')[0],
                            analyst_framework_version: "2.0"
                        },
                        companies: data
                    };
                }

                if (!frcData.companies) {
                    throw new Error('Invalid data structure: companies not found');
                }

                console.log('Companies found:', Object.keys(frcData.companies));
                initializeDashboard();

            } catch (error) {
                console.error('Error loading data:', error);
                // Try alternative loading methods for local file system
                try {
                    console.log('Trying alternative loading method...');
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', 'company.json', true);
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200 || xhr.status === 0) {
                                const data = JSON.parse(xhr.responseText);
                                frcData = data.frc_analysis_report || data;
                                initializeDashboard();
                            } else {
                                createSampleData();
                            }
                        }
                    };
                    xhr.send();
                } catch (xhrError) {
                    console.error('XHR also failed:', xhrError);
                    createSampleData();
                }
            }
        }

        // Create sample data for testing
        function createSampleData() {
            console.log('Creating sample data...');
            frcData = {
                metadata: {
                    report_id: "FRC-ANL-2024-SAMPLE",
                    generation_date: new Date().toISOString().split('T')[0],
                    analyst_framework_version: "2.0"
                },
                companies: {
                    "sample-company": {
                        company_info: {
                            legal_name: "Sample Company Ltd",
                            industry_sector: "Manufacturing",
                            reporting_currency: "BDT",
                            financial_year_end: "December 31",
                            reporting_years: {
                                current_year: "2024",
                                prior_year_1: "2023",
                                prior_year_2: "2022"
                            }
                        },
                        financial_statements_raw_data: {
                            statement_of_financial_position: [
                                {
                                    line_item: "Property, Plant & Equipment",
                                    current_year_amount: "5947021530",
                                    prior_year_1_amount: "5947021530",
                                    prior_year_2_amount: "6126751417",
                                    notes_reference: "3.00"
                                },
                                {
                                    line_item: "Investments",
                                    current_year_amount: "236727536",
                                    prior_year_1_amount: "236727536",
                                    prior_year_2_amount: "236727536",
                                    notes_reference: "4.00"
                                },
                                {
                                    line_item: "Total Assets",
                                    current_year_amount: "6750779608",
                                    prior_year_1_amount: "6748753187",
                                    prior_year_2_amount: "7013399398"
                                }
                            ],
                            statement_of_profit_or_loss_and_oci: [
                                {
                                    line_item: "Revenue",
                                    current_year_amount: "3491969249",
                                    prior_year_1_amount: "3113743215",
                                    prior_year_2_amount: "2342171667",
                                    notes_reference: "16.00"
                                },
                                {
                                    line_item: "Net Profit",
                                    current_year_amount: "6997958",
                                    prior_year_1_amount: "5801759",
                                    prior_year_2_amount: "-851192528"
                                }
                            ],
                            statement_of_cash_flows: [
                                {
                                    line_item: "Cash flows from operating activities",
                                    current_year_amount: "2487666801",
                                    prior_year_1_amount: "2734299740",
                                    prior_year_2_amount: "1561791655"
                                }
                            ]
                        },
                        phase_5_synthesis_and_findings: {
                            overall_assessment: {
                                critical_issues: [
                                    {
                                        issue: "Technical insolvency with negative equity",
                                        priority: "High",
                                        deadline_for_action: "Immediate"
                                    }
                                ]
                            }
                        }
                    }
                }
            };
            initializeDashboard();
            alert('Using sample data. For full functionality, ensure company.json is in the same folder and run a local server.');
        }

        // Initialize dashboard
        function initializeDashboard() {
            if (!frcData || !frcData.companies) {
                console.error('No companies data available');
                return;
            }

            populateCompanyList();
            setupEventListeners();

            // Load first company by default
            const companyIds = Object.keys(frcData.companies);
            if (companyIds.length > 0) {
                loadCompany(companyIds[0]);
            }
        }

        // Populate company list in sidebar
        function populateCompanyList() {
            const companyList = document.getElementById('companyList');
            const mobileCompanyList = document.getElementById('mobileCompanyList');

            if (!companyList || !mobileCompanyList || !frcData.companies) {
                console.error('Required elements not found');
                return;
            }

            companyList.innerHTML = '';
            mobileCompanyList.innerHTML = '';

            Object.keys(frcData.companies).forEach(companyId => {
                const company = frcData.companies[companyId];
                if (!company || !company.company_info) return;

                const listItem = `
                    <a href="#" class="list-group-item list-group-item-action" 
                       data-company-id="${companyId}">
                        <div class="d-flex align-items-center">
                            <div class="company-logo">
                                ${company.company_info.legal_name ? company.company_info.legal_name.charAt(0) : 'C'}
                            </div>
                            <div>
                                <h6 class="mb-0">${company.company_info.legal_name || 'Unknown Company'}</h6>
                                <small class="text-muted">${company.company_info.industry_sector || 'N/A'}</small>
                            </div>
                        </div>
                    </a>
                `;

                companyList.innerHTML += listItem;
                mobileCompanyList.innerHTML += listItem;
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Company selection
            document.addEventListener('click', function (e) {
                const companyLink = e.target.closest('[data-company-id]');
                if (companyLink) {
                    e.preventDefault();
                    const companyId = companyLink.getAttribute('data-company-id');
                    loadCompany(companyId);

                    // Close mobile sidebar on selection
                    const mobileSidebar = document.getElementById('mobileSidebar');
                    if (mobileSidebar && mobileSidebar.classList.contains('show')) {
                        new bootstrap.Collapse(mobileSidebar).hide();
                    }
                }
            });

            // Export button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) exportBtn.addEventListener('click', exportReport);

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.addEventListener('input', function (e) {
                searchCompanies(e.target.value);
            });
        }

        // Load company data
        function loadCompany(companyId) {
            if (!frcData || !frcData.companies || !frcData.companies[companyId]) {
                console.error('Company not found:', companyId);
                return;
            }

            currentCompany = frcData.companies[companyId];
            
            // Determine available years for this company
            currentCompany.availableYears = getAvailableYears(currentCompany);
            currentCompany.yearHeaders = getYearHeaders(currentCompany.availableYears, currentCompany.company_info);

            updateCompanyHeader();
            updateQuickStats();
            updateOverviewTab();
            updateFinancialsTab();
            updateComplianceTab();
            updateAuditTab();
            updateRisksTab();

            // Show quick stats
            const quickStats = document.getElementById('quickStats');
            if (quickStats) quickStats.style.display = 'flex';
        }

        // Update company header
        function updateCompanyHeader() {
            const companyName = document.getElementById('companyName');
            const companyDescription = document.getElementById('companyDescription');
            const complianceStatus = document.getElementById('complianceStatus');
            const auditStatus = document.getElementById('auditStatus');
            const complianceStatusIcon = document.getElementById('complianceStatusIcon');
            const auditStatusIcon = document.getElementById('auditStatusIcon');

            if (!currentCompany || !currentCompany.company_info) return;

            if (companyName) {
                companyName.textContent = currentCompany.company_info.legal_name || 'Unknown Company';
            }

            if (companyDescription) {
                const sector = currentCompany.company_info.industry_sector || 'N/A';
                const fye = currentCompany.company_info.financial_year_end || 'N/A';
                const years = currentCompany.availableYears.map(year => 
                    getYearLabel(year, currentCompany.company_info)
                ).join(', ');
                companyDescription.textContent = `${sector} - FYE: ${fye} - Years: ${years}`;
            }

            // Update compliance status
            const compliance = currentCompany.phase_1_foundational_checks?.reporting_framework?.compliance_assessment || 'Not Assessed';
            if (complianceStatus) complianceStatus.textContent = `Compliance: ${compliance}`;
            if (complianceStatusIcon) {
                complianceStatusIcon.className = 'status-indicator ' +
                    (compliance.toLowerCase().includes('non') ? 'status-critical' :
                        compliance.toLowerCase().includes('partial') ? 'status-warning' : 'status-ok');
            }

            // Update audit status
            const auditOpinion = currentCompany.phase_4_audit_governance_verification?.audit_report_analysis?.audit_opinion?.opinion_type || 'Not Available';
            if (auditStatus) auditStatus.textContent = `Audit: ${auditOpinion}`;
            if (auditStatusIcon) {
                auditStatusIcon.className = 'status-indicator ' +
                    (auditOpinion.toLowerCase().includes('qualified') ? 'status-warning' :
                        auditOpinion.toLowerCase().includes('adverse') ? 'status-critical' : 'status-ok');
            }
        }

        // Update quick stats
        function updateQuickStats() {
            const totalAssetsEl = document.getElementById('totalAssets');
            const netProfitEl = document.getElementById('netProfit');
            const currentRatioEl = document.getElementById('currentRatio');
            const riskLevelEl = document.getElementById('riskLevel');

            if (!currentCompany) return;

            const fsData = currentCompany.financial_statements_raw_data;

            // Total Assets (get latest year)
            if (totalAssetsEl && fsData && fsData.statement_of_financial_position && currentCompany.availableYears.length > 0) {
                const latestYear = currentCompany.availableYears[0];
                const balanceSheet = fsData.statement_of_financial_position;
                const totalAssetItem = balanceSheet.find(item =>
                    item && item.line_item && (
                        item.line_item.toLowerCase().includes('total assets') ||
                        item.line_item.toLowerCase().includes('total assets')
                    )
                );
                totalAssetsEl.textContent =
                    totalAssetItem ? formatCurrency(totalAssetItem[`${latestYear}_amount`]) : '-';
                totalAssetsEl.className = 'full-number';
            }

            // Net Profit
            if (netProfitEl && fsData && fsData.statement_of_profit_or_loss_and_oci && currentCompany.availableYears.length > 0) {
                const latestYear = currentCompany.availableYears[0];
                const incomeStatement = fsData.statement_of_profit_or_loss_and_oci;
                const netProfitItem = incomeStatement.find(item =>
                    item && item.line_item && (
                        item.line_item.toLowerCase().includes('profit') ||
                        item.line_item.toLowerCase().includes('net income') ||
                        item.line_item.toLowerCase().includes('profit after tax')
                    )
                );
                netProfitEl.textContent =
                    netProfitItem ? formatCurrency(netProfitItem[`${latestYear}_amount`]) : '-';
                netProfitEl.className = 'full-number';
            }

            // Current Ratio
            if (currentRatioEl && currentCompany.phase_2_financial_analysis) {
                const ratioAnalysis = currentCompany.phase_2_financial_analysis.ratio_analysis;
                // Try to get ratio for latest year
                const currentRatio = ratioAnalysis?.liquidity_ratios?.current_ratio?.calculation?.current_year?.ratio ||
                                    ratioAnalysis?.liquidity_ratios?.current_ratio?.calculation?.current_year_amount?.ratio ||
                                    'N/A';
                currentRatioEl.textContent = currentRatio;
            }

            // Risk Level
            if (riskLevelEl && currentCompany.phase_5_synthesis_and_findings) {
                const overallAssessment = currentCompany.phase_5_synthesis_and_findings.overall_assessment;
                const criticalIssues = overallAssessment?.critical_issues || [];
                const riskLevel = criticalIssues.length > 0 ? 'High' : 'Low';
                riskLevelEl.textContent = riskLevel;
            }
        }

        // Update overview tab
        function updateOverviewTab() {
            updatePerformanceChart();
            updateKeyFindings();
            updateFinancialSummary();
        }

        // Update performance chart
        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            if (performanceChart) {
                performanceChart.destroy();
            }

            if (!currentCompany || !currentCompany.financial_statements_raw_data) return;

            const fsData = currentCompany.financial_statements_raw_data;
            const incomeStatement = fsData.statement_of_profit_or_loss_and_oci;

            if (!incomeStatement) return;

            // Extract revenue and profit data
            const revenueData = [];
            const profitData = [];
            const years = [];

            const revItem = incomeStatement.find(item =>
                item && item.line_item && (
                    item.line_item.toLowerCase().includes('revenue') ||
                    item.line_item.toLowerCase().includes('interest income')
                )
            );
            const profitItem = incomeStatement.find(item =>
                item && item.line_item && (
                    item.line_item.toLowerCase().includes('profit') ||
                    item.line_item.toLowerCase().includes('net income') ||
                    item.line_item.toLowerCase().includes('profit after tax')
                )
            );

            currentCompany.yearHeaders.forEach(yearHeader => {
                const yearKey = yearHeader.key;
                const revValue = revItem ? parseFloat(revItem[`${yearKey}_amount`] || 0) : 0;
                const profitValue = profitItem ? parseFloat(profitItem[`${yearKey}_amount`] || 0) : 0;

                revenueData.push(revValue);
                profitData.push(profitValue);
                years.push(yearHeader.label);
            });

            performanceChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'Net Profit',
                            data: profitData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return formatDisplayNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update key findings
        function updateKeyFindings() {
            const container = document.getElementById('keyFindings');
            if (!container) return;

            const findings = currentCompany?.phase_5_synthesis_and_findings?.overall_assessment?.critical_issues || [];

            if (findings.length === 0) {
                container.innerHTML = '<div class="alert alert-success">No critical issues identified.</div>';
                return;
            }

            let html = '';
            findings.forEach((finding, index) => {
                const riskClass = getRiskClass(finding.priority);
                html += `
                    <div class="alert ${riskClass} d-flex align-items-start mb-2">
                        <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                        <div>
                            <strong>${finding.issue || 'Unknown Issue'}</strong><br>
                            <small class="text-muted">
                                Priority: ${finding.priority || 'N/A'} | 
                                Action by: ${finding.deadline_for_action || 'N/A'}
                            </small>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update financial summary table
        function updateFinancialSummary() {
            const tbody = document.getElementById('financialSummaryBody');
            if (!tbody || !currentCompany) return;

            const fsData = currentCompany.financial_statements_raw_data;
            if (!fsData) return;

            // Clear and rebuild header if needed
            const thead = document.querySelector('#financialSummaryTable thead');
            if (thead && currentCompany.yearHeaders) {
                let headerHTML = '<tr><th>Year</th><th>Revenue</th><th>Net Profit</th><th>Total Assets</th><th>Total Liabilities</th><th>Equity</th><th>Current Ratio</th><th>ROA</th></tr>';
                thead.innerHTML = headerHTML;
            }

            let html = '';
            
            currentCompany.yearHeaders.forEach((yearHeader, index) => {
                const yearKey = yearHeader.key;
                const yearLabel = yearHeader.label;

                // Get data for each metric
                const revenueItem = fsData.statement_of_profit_or_loss_and_oci?.find(item =>
                    item && item.line_item && (
                        item.line_item.toLowerCase().includes('revenue') ||
                        item.line_item.toLowerCase().includes('interest income')
                    )
                );
                
                const profitItem = fsData.statement_of_profit_or_loss_and_oci?.find(item =>
                    item && item.line_item && (
                        item.line_item.toLowerCase().includes('profit') ||
                        item.line_item.toLowerCase().includes('net income')
                    )
                );
                
                const assetItem = fsData.statement_of_financial_position?.find(item =>
                    item && item.line_item && item.line_item.toLowerCase().includes('total assets')
                );
                
                const liabilityItem = fsData.statement_of_financial_position?.find(item =>
                    item && item.line_item && item.line_item.toLowerCase().includes('total liabilities')
                );
                
                const equityItem = fsData.statement_of_financial_position?.find(item =>
                    item && item.line_item && (
                        item.line_item.toLowerCase().includes('equity') ||
                        item.line_item.toLowerCase().includes('shareholders equity')
                    )
                );

                // Calculate ratios
                const ratioData = currentCompany.phase_2_financial_analysis?.ratio_analysis;
                const currentRatio = ratioData?.liquidity_ratios?.current_ratio?.calculation?.[yearKey]?.ratio || 
                                   ratioData?.liquidity_ratios?.current_ratio?.calculation?.[`${yearKey}_amount`]?.ratio || '-';
                const roa = ratioData?.profitability_ratios?.return_on_assets?.calculation?.[yearKey]?.percentage || 
                           ratioData?.profitability_ratios?.return_on_assets?.calculation?.[`${yearKey}_amount`]?.percentage || '-';

                html += `
                    <tr>
                        <td><span class="year-badge">${yearLabel}</span></td>
                        <td class="full-number">${revenueItem ? formatCurrency(revenueItem[`${yearKey}_amount`]) : '-'}</td>
                        <td class="full-number">${profitItem ? formatCurrency(profitItem[`${yearKey}_amount`]) : '-'}</td>
                        <td class="full-number">${assetItem ? formatCurrency(assetItem[`${yearKey}_amount`]) : '-'}</td>
                        <td class="full-number">${liabilityItem ? formatCurrency(liabilityItem[`${yearKey}_amount`]) : '-'}</td>
                        <td class="full-number">${equityItem ? formatCurrency(equityItem[`${yearKey}_amount`]) : '-'}</td>
                        <td>${currentRatio}</td>
                        <td>${roa}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update financials tab
        function updateFinancialsTab() {
            updateBalanceSheet();
            updateIncomeStatement();
            updateCashFlow();
            updateRatios();
            updateNotes();
        }

        // Update balance sheet table WITH DYNAMIC YEARS
        function updateBalanceSheet() {
            const tbody = document.getElementById('balanceSheetBody');
            if (!tbody || !currentCompany) return;

            const balanceSheet = currentCompany.financial_statements_raw_data?.statement_of_financial_position;
            if (!balanceSheet) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No balance sheet data available</td></tr>';
                return;
            }

            // Update table header with dynamic years
            const thead = document.querySelector('#balanceSheetTable thead');
            if (thead && currentCompany.yearHeaders) {
                let headerHTML = '<tr><th>Line Item</th><th>Note</th>';
                currentCompany.yearHeaders.forEach(year => {
                    headerHTML += `<th>${year.label}</th>`;
                });
                headerHTML += '<th>Change</th></tr>';
                thead.innerHTML = headerHTML;
            }

            let html = '';
            balanceSheet.forEach(item => {
                if (!item) return;

                const noteRef = item.notes_reference;
                let rowHTML = `
                    <tr>
                        <td>${item.line_item || 'Unknown'}</td>
                        <td>${noteRef ? formatNoteReference(noteRef) : ''}</td>
                `;

                // Add data for each year
                currentCompany.yearHeaders.forEach((yearHeader, index) => {
                    const amount = item[`${yearHeader.key}_amount`] || '0';
                    rowHTML += `<td class="full-number">${formatCurrency(amount)}</td>`;
                });

                // Calculate change between first two years if available
                let change = '-';
                if (currentCompany.yearHeaders.length > 1) {
                    const currentAmount = parseFloat(item[`${currentCompany.yearHeaders[0].key}_amount`] || 0);
                    const prevAmount = parseFloat(item[`${currentCompany.yearHeaders[1].key}_amount`] || 0);
                    change = calculateChange(currentAmount, prevAmount);
                }

                rowHTML += `
                    <td class="${change > 0 ? 'text-success' : change < 0 ? 'text-danger' : ''}">
                        ${change !== null && change !== '-' ? change + '%' : '-'}
                    </td>
                `;

                rowHTML += '</tr>';
                html += rowHTML;
            });

            tbody.innerHTML = html;
        }

        // Update income statement table WITH DYNAMIC YEARS
        function updateIncomeStatement() {
            const tbody = document.getElementById('incomeStatementBody');
            if (!tbody || !currentCompany) return;

            const incomeStatement = currentCompany.financial_statements_raw_data?.statement_of_profit_or_loss_and_oci;
            if (!incomeStatement) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No income statement data available</td></tr>';
                return;
            }

            // Update table header with dynamic years
            const thead = document.querySelector('#incomeStatementTable thead');
            if (thead && currentCompany.yearHeaders) {
                let headerHTML = '<tr><th>Line Item</th><th>Note</th>';
                currentCompany.yearHeaders.forEach(year => {
                    headerHTML += `<th>${year.label}</th>`;
                });
                headerHTML += '<th>Change</th></tr>';
                thead.innerHTML = headerHTML;
            }

            let html = '';
            incomeStatement.forEach(item => {
                if (!item) return;

                const noteRef = item.notes_reference;
                let rowHTML = `
                    <tr>
                        <td>${item.line_item || 'Unknown'}</td>
                        <td>${noteRef ? formatNoteReference(noteRef) : ''}</td>
                `;

                // Add data for each year
                currentCompany.yearHeaders.forEach((yearHeader, index) => {
                    const amount = item[`${yearHeader.key}_amount`] || '0';
                    rowHTML += `<td class="full-number">${formatCurrency(amount)}</td>`;
                });

                // Calculate change between first two years if available
                let change = '-';
                if (currentCompany.yearHeaders.length > 1) {
                    const currentAmount = parseFloat(item[`${currentCompany.yearHeaders[0].key}_amount`] || 0);
                    const prevAmount = parseFloat(item[`${currentCompany.yearHeaders[1].key}_amount`] || 0);
                    change = calculateChange(currentAmount, prevAmount);
                }

                rowHTML += `
                    <td class="${change > 0 ? 'text-success' : change < 0 ? 'text-danger' : ''}">
                        ${change !== null && change !== '-' ? change + '%' : '-'}
                    </td>
                `;

                rowHTML += '</tr>';
                html += rowHTML;
            });

            tbody.innerHTML = html;
        }

        // Update cash flow table WITH DYNAMIC YEARS
        function updateCashFlow() {
            const tbody = document.getElementById('cashFlowBody');
            if (!tbody || !currentCompany) return;

            const cashFlow = currentCompany.financial_statements_raw_data?.statement_of_cash_flows;
            if (!cashFlow || cashFlow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No cash flow data available</td></tr>';
                return;
            }

            // Update table header with dynamic years
            const thead = document.querySelector('#cashFlowTable thead');
            if (thead && currentCompany.yearHeaders) {
                let headerHTML = '<tr><th>Cash Flow Category</th><th>Note</th>';
                currentCompany.yearHeaders.forEach(year => {
                    headerHTML += `<th>${year.label}</th>`;
                });
                headerHTML += '</tr>';
                thead.innerHTML = headerHTML;
            }

            let html = '';
            cashFlow.forEach(item => {
                if (!item) return;

                const noteRef = item.notes_reference;
                let rowHTML = `
                    <tr>
                        <td>${item.line_item || 'Unknown'}</td>
                        <td>${noteRef ? formatNoteReference(noteRef) : ''}</td>
                `;

                // Add data for each year
                currentCompany.yearHeaders.forEach(yearHeader => {
                    const amount = item[`${yearHeader.key}_amount`] || '0';
                    rowHTML += `<td class="full-number">${formatCurrency(amount)}</td>`;
                });

                rowHTML += '</tr>';
                html += rowHTML;
            });

            tbody.innerHTML = html;
        }
        // Update equity flow table WITH DYNAMIC YEARS
            function updateEquityFlow() {
            const tbody = document.getElementById('equityFlowBody');
            if (!tbody || !currentCompany) return;

            const equityFlow = currentCompany.financial_statements_raw_data?.statement_of_changes_in_equity;
            if (!equityFlow || equityFlow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No equity flow data available</td></tr>';
                return;
            }

            // Update table header with dynamic years
            const thead = document.querySelector('#equityFlowTable thead');
            if (thead && currentCompany.yearHeaders) {
                let headerHTML = '<tr><th>Equity Flow Category</th><th>Note</th>';
                currentCompany.yearHeaders.forEach(year => {
                    headerHTML += `<th>${year.label}</th>`;
                });
                headerHTML += '</tr>';
                thead.innerHTML = headerHTML;
            }

            let html = '';
            cashFlow.forEach(item => {
                if (!item) return;

                const noteRef = item.notes_reference;
                let rowHTML = `
                    <tr>
                        <td>${item.line_item || 'Unknown'}</td>
                        <td>${noteRef ? formatNoteReference(noteRef) : ''}</td>
                `;

                // Add data for each year
                currentCompany.yearHeaders.forEach(yearHeader => {
                    const amount = item[`${yearHeader.key}_amount`] || '0';
                    rowHTML += `<td class="full-number">${formatCurrency(amount)}</td>`;
                });

                rowHTML += '</tr>';
                html += rowHTML;
            });

            tbody.innerHTML = html;
        }

        // Update ratios display
        function updateRatios() {
            if (!currentCompany || !currentCompany.phase_2_financial_analysis) return;

            const ratioData = currentCompany.phase_2_financial_analysis.ratio_analysis;

            // Liquidity ratios
            const liquidityContainer = document.getElementById('liquidityRatios');
            if (liquidityContainer && ratioData && ratioData.liquidity_ratios) {
                const currentRatio = ratioData.liquidity_ratios.current_ratio;
                const quickRatio = ratioData.liquidity_ratios.quick_ratio;

                let liquidityHtml = '';
                if (currentRatio) {
                    // Try to get ratio for current year
                    let currentRatioValue = 'N/A';
                    if (currentRatio.calculation?.current_year?.ratio) {
                        currentRatioValue = currentRatio.calculation.current_year.ratio;
                    } else if (currentRatio.calculation?.current_year_amount?.ratio) {
                        currentRatioValue = currentRatio.calculation.current_year_amount.ratio;
                    }
                    
                    liquidityHtml += `
                        <div class="mb-2">
                            <strong>Current Ratio:</strong> ${currentRatioValue}
                            <br><small class="text-muted">Benchmark: ${currentRatio.industry_benchmark || 'N/A'}</small>
                        </div>
                    `;
                }
                if (quickRatio) {
                    liquidityHtml += `
                        <div>
                            <strong>Quick Ratio:</strong> ${quickRatio.calculation?.current_year?.ratio || quickRatio.calculation?.current_year_amount?.ratio || 'N/A'}
                            <br><small class="text-muted">Benchmark: ${quickRatio.industry_benchmark || 'N/A'}</small>
                        </div>
                    `;
                }
                liquidityContainer.innerHTML = liquidityHtml;
            }

            // Profitability ratios
            const profitabilityContainer = document.getElementById('profitabilityRatios');
            if (profitabilityContainer && ratioData && ratioData.profitability_ratios) {
                const grossMargin = ratioData.profitability_ratios.gross_profit_margin;
                const roa = ratioData.profitability_ratios.return_on_assets;
                const roe = ratioData.profitability_ratios.return_on_equity;

                let profitabilityHtml = '';
                if (grossMargin) {
                    profitabilityHtml += `
                        <div class="mb-2">
                            <strong>Gross Margin:</strong> ${grossMargin.calculation?.current_year?.percentage || grossMargin.calculation?.current_year_amount?.percentage || 'N/A'}
                            <br><small class="text-muted">Industry: ${grossMargin.industry_benchmark || 'N/A'}</small>
                        </div>
                    `;
                }
                if (roa) {
                    profitabilityHtml += `
                        <div class="mb-2">
                            <strong>Return on Assets:</strong> ${roa.calculation?.current_year?.percentage || roa.calculation?.current_year_amount?.percentage || 'N/A'}
                        </div>
                    `;
                }
                if (roe) {
                    profitabilityHtml += `
                        <div>
                            <strong>Return on Equity:</strong> ${roe.calculation?.current_year?.percentage || roe.calculation?.current_year_amount?.percentage || 'N/A'}
                        </div>
                    `;
                }
                profitabilityContainer.innerHTML = profitabilityHtml;
            }

            // Solvency ratios
            const solvencyContainer = document.getElementById('solvencyRatios');
            if (solvencyContainer && ratioData && ratioData.solvency_ratios) {
                const debtToEquity = ratioData.solvency_ratios.debt_to_equity;
                const interestCoverage = ratioData.solvency_ratios.interest_coverage;

                let solvencyHtml = '';
                if (debtToEquity) {
                    solvencyHtml += `
                        <div class="mb-2">
                            <strong>Debt to Equity:</strong> ${debtToEquity.calculation?.current_year?.ratio || debtToEquity.calculation?.current_year_amount?.ratio || 'N/A'}
                            <br><small class="text-muted">Trend: ${debtToEquity.trend_analysis || 'N/A'}</small>
                        </div>
                    `;
                }
                if (interestCoverage) {
                    solvencyHtml += `
                        <div>
                            <strong>Interest Coverage:</strong> ${interestCoverage.calculation?.current_year?.ratio || interestCoverage.calculation?.current_year_amount?.ratio || 'N/A'}
                            <br><small class="text-muted">Minimum Required: ${interestCoverage.minimum_requirement || 'N/A'}</small>
                        </div>
                    `;
                }
                solvencyContainer.innerHTML = solvencyHtml;
            }

            // Efficiency ratios
            const efficiencyContainer = document.getElementById('efficiencyRatios');
            if (efficiencyContainer && ratioData && ratioData.efficiency_ratios) {
                const inventoryTurnover = ratioData.efficiency_ratios.inventory_turnover;
                const assetTurnover = ratioData.efficiency_ratios.asset_turnover;

                let efficiencyHtml = '';
                if (inventoryTurnover) {
                    efficiencyHtml += `
                        <div class="mb-2">
                            <strong>Inventory Turnover:</strong> ${inventoryTurnover.calculation?.current_year?.ratio || inventoryTurnover.calculation?.current_year_amount?.ratio || 'N/A'}
                            <br><small class="text-muted">Days: ${inventoryTurnover.calculation?.current_year?.days || 'N/A'}</small>
                        </div>
                    `;
                }
                if (assetTurnover) {
                    efficiencyHtml += `
                        <div>
                            <strong>Asset Turnover:</strong> ${assetTurnover.calculation?.current_year?.ratio || assetTurnover.calculation?.current_year_amount?.ratio || 'N/A'}
                            <br><small class="text-muted">Trend: ${assetTurnover.trend_analysis || 'N/A'}</small>
                        </div>
                    `;
                }
                efficiencyContainer.innerHTML = efficiencyHtml;
            }
        }

        // Update notes content
        function updateNotes() {
            const container = document.getElementById('notesContent');
            if (!container || !currentCompany) return;

            // Collect all unique note references
            const noteSet = new Set();
            const fsData = currentCompany.financial_statements_raw_data;

            if (fsData) {
                // Check balance sheet
                if (fsData.statement_of_financial_position) {
                    fsData.statement_of_financial_position.forEach(item => {
                        if (item.notes_reference) {
                            if (typeof item.notes_reference === 'string') {
                                noteSet.add(item.notes_reference);
                            } else if (typeof item.notes_reference === 'object') {
                                Object.values(item.notes_reference).forEach(note => {
                                    if (note) noteSet.add(note);
                                });
                            }
                        }
                    });
                }

                // Check income statement
                if (fsData.statement_of_profit_or_loss_and_oci) {
                    fsData.statement_of_profit_or_loss_and_oci.forEach(item => {
                        if (item.notes_reference) {
                            if (typeof item.notes_reference === 'string') {
                                noteSet.add(item.notes_reference);
                            } else if (typeof item.notes_reference === 'object') {
                                Object.values(item.notes_reference).forEach(note => {
                                    if (note) noteSet.add(note);
                                });
                            }
                        }
                    });
                }

                // Check cash flow
                if (fsData.statement_of_cash_flows) {
                    fsData.statement_of_cash_flows.forEach(item => {
                        if (item.notes_reference) {
                            if (typeof item.notes_reference === 'string') {
                                noteSet.add(item.notes_reference);
                            } else if (typeof item.notes_reference === 'object') {
                                Object.values(item.notes_reference).forEach(note => {
                                    if (note) noteSet.add(note);
                                });
                            }
                        }
                    });
                }
                // Check equity flow
                if (fsData.statement_of_changes_in_equity) {
                    fsData.statement_of_changes_in_equity.forEach(item => {
                        if (item.notes_reference) {
                            if (typeof item.notes_reference === 'string') {
                                noteSet.add(item.notes_reference);
                            } else if (typeof item.notes_reference === 'object') {
                                Object.values(item.notes_reference).forEach(note => {
                                    if (note) noteSet.add(note);
                                });
                            }
                        }
                    });
                }
            }

            // Convert to array and sort
            const notes = Array.from(noteSet).sort();

            if (notes.length === 0) {
                container.innerHTML = '<p class="text-muted">No note references found in financial statements.</p>';
                return;
            }

            let html = '<div class="row">';
            notes.forEach(note => {
                html += `
                    <div class="col-md-3 col-sm-4 col-6 mb-2">
                        <span class="note-number">${note}</span>
                        <small class="text-muted">Note reference</small>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // Update compliance tab
        function updateComplianceTab() {
            updateComplianceTable();
            updateComplianceChart();
            updateMaterialDepartures();
        }

        // Update compliance table
        function updateComplianceTable() {
            const tbody = document.getElementById('complianceBody');
            if (!tbody || !currentCompany) return;

            const complianceMatrix = currentCompany.phase_3_ifrs_compliance_detailed?.detailed_ifrs_compliance_matrix;

            if (!complianceMatrix || complianceMatrix.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No compliance data available</td></tr>';
                return;
            }

            let html = '';
            complianceMatrix.forEach(item => {
                if (!item) return;

                const complianceStatus = item.compliance_status?.toLowerCase() || '';
                const complianceClass = complianceStatus.includes('non') ? 'compliance-non-compliant' :
                    complianceStatus.includes('partial') ? 'compliance-partial' :
                        'compliance-compliant';

                html += `
                    <tr>
                        <td>
                            <strong>${item.standard_code || 'N/A'}</strong><br>
                            <small>${item.standard_name || 'N/A'}</small>
                        </td>
                        <td>
                            <span class="compliance-badge ${complianceClass}">
                                ${item.compliance_status || 'N/A'}
                            </span>
                        </td>
                        <td>
                            <ul class="mb-0" style="padding-left: 1rem; font-size: 0.9em;">
                                ${(item.specific_requirements_checked || []).map(req =>
                    `<li>${req.requirement || 'N/A'}: ${req.compliance_status || 'N/A'}</li>`
                ).join('')}
                            </ul>
                        </td>
                        <td>
                            <small>${(item.material_departures || []).join(', ') || 'None'}</small>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update compliance chart
        function updateComplianceChart() {
            const ctx = document.getElementById('complianceChart');
            if (!ctx) return;

            if (complianceChart) {
                complianceChart.destroy();
            }

            const complianceMatrix = currentCompany?.phase_3_ifrs_compliance_detailed?.detailed_ifrs_compliance_matrix;
            if (!complianceMatrix) return;

            // Count compliance status
            let compliant = 0, partial = 0, nonCompliant = 0;
            complianceMatrix.forEach(item => {
                if (!item || !item.compliance_status) return;

                const status = item.compliance_status.toLowerCase();
                if (status.includes('non')) {
                    nonCompliant++;
                } else if (status.includes('partial')) {
                    partial++;
                } else {
                    compliant++;
                }
            });

            complianceChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Compliant', 'Partially Compliant', 'Non-Compliant'],
                    datasets: [{
                        data: [compliant, partial, nonCompliant],
                        backgroundColor: [
                            'rgb(75, 192, 192)',
                            'rgb(255, 205, 86)',
                            'rgb(255, 99, 132)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = compliant + partial + nonCompliant;
                                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update material departures
        function updateMaterialDepartures() {
            const container = document.getElementById('materialDepartures');
            if (!container || !currentCompany) return;

            const departures = currentCompany.phase_5_synthesis_and_findings?.material_departures_summary;

            if (!departures || departures.length === 0) {
                container.innerHTML = '<div class="alert alert-success">No material departures identified.</div>';
                return;
            }

            let html = '';
            departures.forEach((departure, index) => {
                if (!departure) return;

                html += `
                    <div class="alert alert-danger mb-2">
                        <strong>${departure.issue_description || 'Unknown Issue'}</strong><br>
                        <small class="text-muted">
                            Standard: ${departure.relevant_standard || 'N/A'} | 
                            Impact: ${formatCurrency(departure.financial_impact) || 'N/A'}<br>
                            Action: ${departure.recommended_action || 'N/A'}
                        </small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update audit tab
        function updateAuditTab() {
            updateAuditAnalysis();
            updateGovernanceAnalysis();
            updateKeyAuditMatters();
        }

        // Update audit analysis
        function updateAuditAnalysis() {
            const container = document.getElementById('auditAnalysis');
            if (!container || !currentCompany) return;

            const auditData = currentCompany.phase_4_audit_governance_verification?.audit_report_analysis;

            if (!auditData) {
                container.innerHTML = '<p class="text-muted">No audit data available.</p>';
                return;
            }

            const goingConcern = auditData.going_concern_assessment;

            let html = `
                <p><strong>Auditor:</strong> ${auditData.auditor_information?.firm_name || 'N/A'}</p>
                <p><strong>Opinion:</strong> ${auditData.audit_opinion?.opinion_type || 'N/A'}</p>
                <p><strong>Audit Tenure:</strong> ${auditData.auditor_information?.audit_tenure_years || 'N/A'} years</p>
            `;

            if (goingConcern?.material_uncertainty_disclosed) {
                html += `
                    <div class="alert alert-warning mt-3">
                        <strong><i class="bi bi-exclamation-triangle-fill me-1"></i> Going Concern Uncertainty</strong><br>
                        <small>${goingConcern.frc_assessment || goingConcern.auditor_conclusion || 'Material uncertainty exists'}</small>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Update governance analysis
        function updateGovernanceAnalysis() {
            const container = document.getElementById('governanceAnalysis');
            if (!container || !currentCompany) return;

            const governanceData = currentCompany.phase_4_audit_governance_verification?.corporate_governance_review;

            if (!governanceData) {
                container.innerHTML = '<p class="text-muted">No governance data available.</p>';
                return;
            }

            let html = '';
            if (governanceData.board_structure) {
                const board = governanceData.board_structure;
                html += `
                    <p><strong>Board Size:</strong> ${board.board_size || 'Not Disclosed'}</p>
                    <p><strong>Independent Directors:</strong> ${board.independent_directors || 'Not Disclosed'}</p>
                    <p><strong>BSEC Compliance:</strong> ${board.bsec_compliance || 'N/A'}</p>
                `;
            }

            container.innerHTML = html || '<p class="text-muted">No governance information available.</p>';
        }

        // Update key audit matters
        function updateKeyAuditMatters() {
            const container = document.getElementById('keyAuditMatters');
            if (!container || !currentCompany) return;

            const kam = currentCompany.phase_4_audit_governance_verification?.audit_report_analysis?.key_audit_matters;

            if (!kam || kam.length === 0) {
                container.innerHTML = '<p class="text-muted">No key audit matters reported.</p>';
                return;
            }

            let html = '';
            kam.forEach((matter, index) => {
                if (!matter) return;

                const riskClass = getRiskClass(matter.frc_risk_assessment);
                html += `
                    <div class="alert ${riskClass} mb-3">
                        <strong>${matter.matter || 'Unknown Matter'}</strong>
                        <p class="mb-1"><small>Auditor Response: ${matter.auditor_response || 'N/A'}</small></p>
                        <p class="mb-0"><small>FRC Assessment: ${matter.frc_risk_assessment || 'N/A'}</small></p>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update risks tab
        function updateRisksTab() {
            updateRiskChart();
            updateRiskIndicators();
            updateGoingConcern();
        }

        // Update risk chart
        function updateRiskChart() {
            const ctx = document.getElementById('riskChart');
            if (!ctx) return;

            if (riskChart) {
                riskChart.destroy();
            }

            // Sample risk categories
            const riskCategories = [
                'Credit Risk',
                'Market Risk',
                'Operational Risk',
                'Liquidity Risk',
                'Compliance Risk'
            ];

            // Sample risk scores (in real app, calculate from data)
            const riskScores = [7, 5, 6, 8, 9];

            riskChart = new Chart(ctx.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: riskCategories,
                    datasets: [{
                        label: 'Risk Assessment',
                        data: riskScores,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(255, 99, 132)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 10
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // Update risk indicators
        function updateRiskIndicators() {
            const container = document.getElementById('riskIndicators');
            if (!container || !currentCompany) return;

            const riskData = currentCompany.phase_5_synthesis_and_findings?.risk_factor_consolidation;

            if (!riskData) {
                container.innerHTML = '<p class="text-muted">No risk indicators available.</p>';
                return;
            }

            let html = '';
            ['high_risk_factors', 'medium_risk_factors', 'low_risk_factors'].forEach(riskLevel => {
                const factors = riskData[riskLevel] || [];
                if (factors.length > 0) {
                    const levelName = riskLevel.split('_')[0].toUpperCase();
                    html += `<h6 class="mt-3">${levelName} RISK</h6>`;

                    factors.forEach(factor => {
                        if (!factor) return;

                        html += `
                            <div class="alert ${getRiskClass(levelName.toLowerCase())} py-2 mb-2">
                                <strong>${factor.risk_category || 'Unknown Category'}</strong><br>
                                <small>${factor.risk_description || 'No description'}</small>
                            </div>
                        `;
                    });
                }
            });

            container.innerHTML = html || '<p class="text-muted">No risk factors identified.</p>';
        }

        // Update going concern assessment
        function updateGoingConcern() {
            const container = document.getElementById('goingConcern');
            if (!container || !currentCompany) return;

            const gcData = currentCompany.phase_2_financial_analysis?.going_concern_assessment ||
                currentCompany.phase_4_audit_governance_verification?.audit_report_analysis?.going_concern_assessment;

            if (!gcData) {
                container.innerHTML = '<p class="text-muted">No going concern assessment available.</p>';
                return;
            }

            let html = '';
            if (gcData.indicators) {
                html += '<h6>Indicators:</h6><ul>';
                gcData.indicators.forEach(indicator => {
                    if (!indicator) return;

                    const severityClass = indicator.severity === 'Critical' ? 'text-danger' :
                        indicator.severity === 'High' ? 'text-warning' : 'text-success';
                    html += `<li><span class="${severityClass}">${indicator.indicator || 'Unknown'}:</span> ${indicator.status || 'N/A'}</li>`;
                });
                html += '</ul>';
            }

            if (gcData.overall_assessment) {
                const alertClass = gcData.overall_assessment.toLowerCase().includes('uncertainty') ? 'alert-warning' : 'alert-success';
                html += `
                    <div class="alert ${alertClass} mt-3">
                        <strong>Overall Assessment:</strong> ${gcData.overall_assessment}
                    </div>
                `;
            }

            container.innerHTML = html || '<p class="text-muted">No going concern assessment available.</p>';
        }

        // Search companies
        function searchCompanies(query) {
            const companyLinks = document.querySelectorAll('[data-company-id]');
            companyLinks.forEach(link => {
                const companyName = link.textContent.toLowerCase();
                if (companyName.includes(query.toLowerCase())) {
                    link.style.display = 'flex';
                } else {
                    link.style.display = 'none';
                }
            });
        }

        // Export comprehensive FRC report
        async function exportReport() {
            if (!currentCompany) {
                alert('Please select a company first.');
                return;
            }

            try {
                // Show watermark
                const watermark = document.getElementById('confidentialWatermark');
                if (watermark) watermark.classList.remove('d-none');

                // Create a comprehensive PDF report
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                // Add FRC Confidential Header
                doc.setFontSize(16);
                doc.setTextColor(40, 40, 40);
                doc.text('FINANCIAL REPORTING COUNCIL (FRC)', 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text('CONFIDENTIAL REGULATORY ANALYSIS REPORT', 105, 27, { align: 'center' });

                // Add line separator
                doc.setDrawColor(200, 200, 200);
                doc.line(20, 32, 190, 32);

                // Report Details
                doc.setFontSize(9);
                doc.text(`Report ID: ${frcData.metadata?.report_id || 'N/A'}`, 20, 40);
                doc.text(`Generated: ${frcData.metadata?.generation_date || new Date().toISOString().split('T')[0]}`, 20, 45);
                doc.text(`Analyst Framework: v${frcData.metadata?.analyst_framework_version || '1.0'}`, 20, 50);

                doc.text(`Company: ${currentCompany.company_info?.legal_name || 'N/A'}`, 130, 40);
                doc.text(`Sector: ${currentCompany.company_info?.industry_sector || 'N/A'}`, 130, 45);
                doc.text(`Year End: ${currentCompany.company_info?.financial_year_end || 'N/A'}`, 130, 50);

                // Add confidentiality warning
                doc.setFontSize(8);
                doc.setTextColor(150, 0, 0);
                doc.text('CONFIDENTIAL - FOR INTERNAL FRC USE ONLY', 105, 58, { align: 'center' });
                doc.setTextColor(0, 0, 0);

                // Add page number
                let page = 1;
                const addPageNumber = () => {
                    doc.setFontSize(8);
                    doc.text(`Page ${page}`, 190, 285, { align: 'right' });
                    page++;
                };
                addPageNumber();

                // EXECUTIVE SUMMARY
                doc.addPage();
                doc.setFontSize(14);
                doc.text('1. EXECUTIVE SUMMARY', 20, 20);
                doc.setFontSize(10);

                const overallAssessment = currentCompany.phase_5_synthesis_and_findings?.overall_assessment;
                const compliance = currentCompany.phase_1_foundational_checks?.reporting_framework?.compliance_assessment || 'Not Assessed';
                const auditOpinion = currentCompany.phase_4_audit_governance_verification?.audit_report_analysis?.audit_opinion?.opinion_type || 'Not Available';

                let yPos = 30;
                doc.text(`Company Name: ${currentCompany.company_info?.legal_name || 'N/A'}`, 20, yPos);
                yPos += 7;
                doc.text(`Overall Compliance: ${compliance}`, 20, yPos);
                yPos += 7;
                doc.text(`Audit Opinion: ${auditOpinion}`, 20, yPos);
                yPos += 7;
                doc.text(`Reliability Score: ${overallAssessment?.reliability_score || 'N/A'}`, 20, yPos);
                yPos += 7;
                doc.text(`Transparency Rating: ${overallAssessment?.transparency_rating || 'N/A'}`, 20, yPos);
                yPos += 10;

                // Critical Issues
                if (overallAssessment?.critical_issues && overallAssessment.critical_issues.length > 0) {
                    doc.setFontSize(12);
                    doc.setTextColor(200, 0, 0);
                    doc.text('CRITICAL ISSUES REQUIRING ACTION:', 20, yPos);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    yPos += 10;

                    overallAssessment.critical_issues.forEach((issue, index) => {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${index + 1}. ${issue.issue || 'Unknown Issue'}`, 20, yPos);
                        doc.setFont(undefined, 'normal');
                        yPos += 5;
                        doc.text(`   Priority: ${issue.priority || 'N/A'} | Deadline: ${issue.deadline_for_action || 'N/A'}`, 25, yPos);
                        yPos += 7;

                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                            addPageNumber();
                        }
                    });
                }

                addPageNumber();

                // FINANCIAL ANALYSIS
                doc.addPage();
                doc.setFontSize(14);
                doc.text('2. FINANCIAL ANALYSIS', 20, 20);

                // Financial Summary Table
                const fsData = currentCompany.financial_statements_raw_data;
                if (fsData) {
                    yPos = 30;
                    doc.setFontSize(10);
                    doc.text('Financial Highlights (Full Numbers):', 20, yPos);
                    yPos += 10;

                    // Create table data
                    const tableData = [
                        ['Year', 'Revenue', 'Net Profit', 'Total Assets', 'Total Liabilities', 'Equity', 'Current Ratio', 'ROA']
                    ];

                    // Add data for each year
                    currentCompany.yearHeaders.forEach(yearHeader => {
                        const yearKey = yearHeader.key;
                        const yearLabel = yearHeader.label;

                        // Get data for each metric
                        const revenueItem = fsData.statement_of_profit_or_loss_and_oci?.find(item =>
                            item && item.line_item && (
                                item.line_item.toLowerCase().includes('revenue') ||
                                item.line_item.toLowerCase().includes('interest income')
                            )
                        );
                        
                        const profitItem = fsData.statement_of_profit_or_loss_and_oci?.find(item =>
                            item && item.line_item && (
                                item.line_item.toLowerCase().includes('profit') ||
                                item.line_item.toLowerCase().includes('net income')
                            )
                        );
                        
                        const assetItem = fsData.statement_of_financial_position?.find(item =>
                            item && item.line_item && item.line_item.toLowerCase().includes('total assets')
                        );
                        
                        const liabilityItem = fsData.statement_of_financial_position?.find(item =>
                            item && item.line_item && item.line_item.toLowerCase().includes('total liabilities')
                        );
                        
                        const equityItem = fsData.statement_of_financial_position?.find(item =>
                            item && item.line_item && (
                                item.line_item.toLowerCase().includes('equity') ||
                                item.line_item.toLowerCase().includes('shareholders equity')
                            )
                        );

                        // Calculate ratios
                        const ratioData = currentCompany.phase_2_financial_analysis?.ratio_analysis;
                        const currentRatio = ratioData?.liquidity_ratios?.current_ratio?.calculation?.[yearKey]?.ratio || 
                                           ratioData?.liquidity_ratios?.current_ratio?.calculation?.[`${yearKey}_amount`]?.ratio || '-';
                        const roa = ratioData?.profitability_ratios?.return_on_assets?.calculation?.[yearKey]?.percentage || 
                                   ratioData?.profitability_ratios?.return_on_assets?.calculation?.[`${yearKey}_amount`]?.percentage || '-';

                        tableData.push([
                            yearLabel,
                            revenueItem ? formatNumber(revenueItem[`${yearKey}_amount`]) : '-',
                            profitItem ? formatNumber(profitItem[`${yearKey}_amount`]) : '-',
                            assetItem ? formatNumber(assetItem[`${yearKey}_amount`]) : '-',
                            liabilityItem ? formatNumber(liabilityItem[`${yearKey}_amount`]) : '-',
                            equityItem ? formatNumber(equityItem[`${yearKey}_amount`]) : '-',
                            currentRatio,
                            roa
                        ]);
                    });

                    // Add table to PDF
                    doc.autoTable({
                        startY: yPos,
                        head: [tableData[0]],
                        body: tableData.slice(1),
                        theme: 'striped',
                        headStyles: { fillColor: [44, 62, 80] },
                        margin: { left: 20 }
                    });
                }

                addPageNumber();

                // IFRS COMPLIANCE
                doc.addPage();
                doc.setFontSize(14);
                doc.text('3. IFRS COMPLIANCE ASSESSMENT', 20, 20);

                const complianceMatrix = currentCompany.phase_3_ifrs_compliance_detailed?.detailed_ifrs_compliance_matrix;
                if (complianceMatrix && complianceMatrix.length > 0) {
                    yPos = 30;
                    doc.setFontSize(10);

                    // Material Departures
                    const departures = currentCompany.phase_5_synthesis_and_findings?.material_departures_summary;
                    if (departures && departures.length > 0) {
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(200, 0, 0);
                        doc.text('MATERIAL DEPARTURES IDENTIFIED:', 20, yPos);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'normal');
                        yPos += 7;

                        departures.forEach((departure, index) => {
                            if (!departure) return;

                            doc.text(`${index + 1}. ${departure.issue_description || 'Unknown'}`, 25, yPos);
                            yPos += 5;
                            doc.text(`   Standard: ${departure.relevant_standard || 'N/A'}`, 30, yPos);
                            yPos += 7;

                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                                addPageNumber();
                            }
                        });
                    }
                }

                addPageNumber();

                // FINAL PAGE
                doc.addPage();
                doc.setFontSize(16);
                doc.setTextColor(40, 40, 40);
                doc.text('FRC CONFIDENTIAL ANALYSIS REPORT', 105, 100, { align: 'center' });
                doc.setFontSize(12);
                doc.text('--- END OF REPORT ---', 105, 120, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('This report contains confidential regulatory analysis prepared for internal FRC use only.', 105, 150, { align: 'center' });
                doc.text('Unauthorized distribution, reproduction, or disclosure is strictly prohibited.', 105, 160, { align: 'center' });

                doc.setFontSize(8);
                doc.text(`Report Generated: ${new Date().toLocaleString()}`, 105, 180, { align: 'center' });
                doc.text(`Analyst Framework: v${frcData.metadata?.analyst_framework_version || '1.0'}`, 105, 190, { align: 'center' });

                addPageNumber();

                // Save the PDF
                const fileName = `FRC_Report_${currentCompany.company_info?.legal_name?.replace(/\s+/g, '_') || 'Company'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                // Hide watermark
                if (watermark) watermark.classList.add('d-none');

                console.log('PDF generated successfully:', fileName);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF report. Please check console for details.');

                // Hide watermark if error occurs
                const watermark = document.getElementById('confidentialWatermark');
                if (watermark) watermark.classList.add('d-none');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>